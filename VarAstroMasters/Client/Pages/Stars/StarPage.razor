@page "/Stars/{StarId:int}"

@inject IStarService StarService
@inject ILightCurveService LightCurveService

<PageTitle>@(Star is null ? "" : Star.Name) | @Keywords.DefaultPageTitle</PageTitle>

@if (Star == null)
{
    <Loader/>
}
else
{
    <div class="d-flex justify-content-between">
        <h3>Hviezda <strong>@Star.Name</strong></h3>
        <a class="btn btn-outline-primary" href="@Endpoints.ClientLightCurvePost/@Star.Id">Pridať pozorovanie</a>
    </div>

    <AuthorizeView Roles="Administrator">
        <section>
            <h4>Administrácia hviezdy</h4>
            <a href="@Endpoints.ClientAdminStars/@Star.Id/Publication" class="btn btn-primary">Spravovať publikáciu</a>
            <a href="@Endpoints.ClientAdminStars/@Star.Id/Catalogs" class="btn btn-primary">Identifikácia v katalógoch</a>
        </section>
    </AuthorizeView>

    <MudCard Class="mb-5">
        <MudCardContent>
            <MudText Typo="Typo.h5">Údaje o hviezde</MudText>
            <StarMetaListTable Data="Star"></StarMetaListTable>
        </MudCardContent>
    </MudCard>

    <MudCard Class="mb-5">
        <MudCardContent>
            <MudText Typo="Typo.h5">Prítomnosť hviezdy v katalógoch</MudText>
            @if (Star is {StarCatalogs: not null, StarCatalogs.Count: > 0})
            {
                <MudTable Striped="true" Items="Star.StarCatalogs" Hover="true" T="StarCatalog">
                    <HeaderContent>
                        <MudTh>Katalóg</MudTh>
                        <MudTh>RA</MudTh>
                        <MudTh>DEC</MudTh>
                        <MudTh>MAG</MudTh>
                        <MudTh>Cross ID</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Katalóg">
                            @context.CatalogId
                        </MudTd>
                        <MudTd DataLabel="RA">
                            @context.Ra
                        </MudTd>
                        <MudTd DataLabel="DEC">
                            @context.Dec
                        </MudTd>
                        <MudTd DataLabel="MAG">
                            @context.Mag
                        </MudTd>
                        <MudTd DataLabel="Cross ID">
                            @context.CrossId
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
            else
            {
                <h4>Táto hviezda sa nenachádza v žiadnych katalógoch.</h4>
            }
        </MudCardContent>
    </MudCard>

    <MudCard Class="mb-5">
        <MudCardContent>
            <h4> Pozorovanie tejto hviezdy</h4>
            @if (Star is {LightCurves.Count: 0})
            {
                <h5>
                    Táto hviezda nemá žiadne pozorovania.
                </h5>
            }
            else if (Star is {LightCurves.Count: > 0})
            {
                <LightCurveListWithValues Curves="@Star.LightCurves" CurveLayout="col-12"/>
            }
        </MudCardContent>
    </MudCard>
}

@code {

    [Parameter]
    public int StarId { get; set; }

    private StarDTO? Star { get; set; }
    private StarCatalog? PrimaryStarCatalog { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var response = await StarService.GetStarAsync(StarId);
        if (response is {Success: true, Data: not null})
        {
            Star = response.Data;
            PrimaryStarCatalog = Star.StarCatalogs?.FirstOrDefault(sc => sc.Primary);
            GetCurveValues();
        }
    }

    private async Task GetCurveValues()
    {
        foreach (var lc in Star.LightCurves)
        {
            var result = await LightCurveService.LightCurveSingleValuesGet(lc.Id);
            if (result is {Success: true, Data: not null})
            {
                lc.Values = result.Data;
            }
            lc.ValuesFinishedLoading = true;
            StateHasChanged();
        }
    }

}