@page "/Stars/{StarId:int}"

@inject IStarService StarService
@inject ILightCurveService LightCurveService

<PageTitle>@(Star is null ? "" : Star.Name) | @Keywords.DefaultPageTitle</PageTitle>

@if (Star == null)
{
    <Loader/>
}
else
{
    <div class="d-flex justify-content-between">
        <h3>Hviezda <strong>@Star.Name</strong></h3>
        <a class="btn btn-outline-primary" href="@Endpoints.ClientLightCurvePost/@Star.Id">Pridať pozorovanie</a>
    </div>

    <AuthorizeView Roles="Administrator">
        <section>
            <h4>Administrácia hviezdy</h4>
            <a href="@Endpoints.ClientAdminStars/@Star.Id/Publication" class="btn btn-primary">Spravovať publikáciu</a>
            <a href="@Endpoints.ClientAdminStars/@Star.Id/Catalogs" class="btn btn-primary">Identifikácia v katalógoch</a>
        </section>
    </AuthorizeView>

    <section>
        <h4>Údaje o hviezde</h4>
        <ResponsiveTable>
            <tbody>
            @if (Star is {StarVariability: not null})
            {
                <tr>
                    <th scope="row">Epocha</th>
                    <td>@Star.StarVariability.Epoch</td>
                </tr>
                <tr>
                    <th scope="row">Perióda</th>
                    <td>@Star.StarVariability.Period</td>
                </tr>
                <tr>
                    <th scope="row">Primárne minimum</th>
                    <td>@Star.StarVariability.PrimaryMinimum</td>
                </tr>
                <tr>
                    <th scope="row">Typ premennej hviezdy</th>
                    <td>
                        @if (Star.StarVariability.VariabilityType == VariabilityType.Intrinsic)
                        {
                            <span>Fyzikálna</span>
                        }
                        else if (Star.StarVariability.VariabilityType == VariabilityType.Extrinsic)
                        {
                            <span>Geometrická</span>
                        }
                        else
                        {
                            <span>-</span>
                        }
                    </td>
                </tr>
            }
            @if (PrimaryStarCatalog is not null)
            {
                <tr>
                    <th scope="row">RA</th>
                    <td>@PrimaryStarCatalog.Ra (@PrimaryStarCatalog.CatalogId)</td>
                </tr>
                <tr>
                    <th scope="row">DEC</th>
                    <td>@PrimaryStarCatalog.Dec (@PrimaryStarCatalog.CatalogId)</td>
                </tr>
            }
            @if (Star is {StarPublish: not null})
            {
                <tr>
                    <th scope="row">Objavená</th>
                    <td>@Star.StarPublish.Year</td>
                </tr>
                <tr>
                    <th scope="row">Objaviteľ</th>
                    <td>@Star.StarPublish.Discoverer</td>
                </tr>
                <tr>
                    <th scope="row">Odkaz na publikáciu</th>
                    <td>
                        <a href="/@Star.StarPublish.PublicationLink" target="_blank" rel="noopener noreferrer">@Star.StarPublish.PublicationLink</a>
                    </td>
                </tr>
            }
            else
            {
                <tr>
                    <th scope="row">Publikovaná</th>
                    <td>Nie</td>
                </tr>
            }
            </tbody>
        </ResponsiveTable>
    </section>
    <section>
        <h4>Prítomnosť hviezdy v katalógoch</h4>
        @if (Star is {StarCatalogs: not null, StarCatalogs.Count: > 0})
        {
            <ResponsiveTable>
                <thead>
                <tr>
                    <th scope="col">Katalóg</th>
                    <th scope="col">
                        RA
                    </th>
                    <th scope="col">
                        DEC
                    </th>
                    <th scope="col">
                        MAG
                    </th>
                    <th scope="col">
                        Cross-ID
                    </th>
                </tr>
                </thead>
                <tbody>

                @foreach (var sc in Star.StarCatalogs)
                {
                    <tr>
                        <th scope="row">@sc.CatalogId</th>
                        <td>@sc.Ra</td>
                        <td>@sc.Dec</td>
                        <td>@sc.Mag</td>
                        <td>@sc.CrossId</td>
                    </tr>
                }
                </tbody>
            </ResponsiveTable>
        }
        else
        {
            <h4>Táto hviezda sa nenachádza v žiadnych katalógoch.</h4>
        }
    </section>

    <section>
        <h4> Pozorovanie tejto hviezdy</h4>
        @if (Star is {LightCurves.Count: 0})
        {
            <h5>
                Táto hviezda nemá žiadne pozorovania.
            </h5>
        }
        else if (Star is {LightCurves.Count: > 0})
        {
            <ul>
                @if (loadingCurveValues)
                {
                    <li>
                        <Loader/>
                    </li>
                }
                else
                {
                    @foreach (var curve in Star.LightCurves)
                    {
                        <li>
                            <a href="@Endpoints.ClientLightCurveSingleGet/@curve.Id"> @curve.Id (@curve.User.Name) </a>
                            @if (curve.Values is not null)
                            {
                                <ScatterChart Values="@curve.Values"></ScatterChart>
                            }
                        </li>
                    }
                }
            </ul>
        }
    </section>
}

@code {

    [Parameter]
    public int StarId { get; set; }

    private StarDTO? Star { get; set; }
    private StarCatalog? PrimaryStarCatalog { get; set; }
    private bool loadingCurveValues { get; set; } = true;

    protected override async Task OnInitializedAsync()
    {
        var response = await StarService.GetStarAsync(StarId);
        if (response.Success)
        {
            Star = response.Data;
            PrimaryStarCatalog = Star?.StarCatalogs?.FirstOrDefault(sc => sc.Primary);
            GetCurveValues();
        }
    }

    private async Task GetCurveValues()
    {
        foreach (var lc in Star.LightCurves)
        {
            var res = await LightCurveService.GetLightCurveValues(lc.Id);
            if (res.Success)
            {
                lc.Values = res.Data;
            }
        }
        loadingCurveValues = false;
        StateHasChanged();
    }

}